<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACE Kendo Academy Leaderboards</title>

  <style>
    :root{
      --bg:#050607;
      --text:#ffffff;
      --muted:#c9c9c9;

      --accent:#e11d2e;
      --accent2:#ff2a3c;

      --line:rgba(255,255,255,0.10);
      --shadow: rgba(0,0,0,0.65);

      /* Division accents */
      --kids: #ffb020;
      --teens:#7c3aed;
      --adults:#22c55e;

      /* Rank accents (reusing cat1/2/3 classes) */
      --cat1:#c0c0c0; /* Silver */
      --cat2:#f7c948; /* Gold */
      --cat3:#38bdf8; /* Diamond */
      --cat4:#ff2a3c; /* Champion */

      --gold:#f7c948;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      height:100vh;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(225,29,46,0.14), rgba(0,0,0,0)),
        radial-gradient(900px 600px at 80% 35%, rgba(225,29,46,0.10), rgba(0,0,0,0)),
        linear-gradient(180deg, #000, var(--bg));
    }

    .energy{
      position:fixed; inset:-20%;
      pointer-events:none;
      background:
        radial-gradient(520px 340px at 18% 30%, rgba(255,42,60,0.18), rgba(0,0,0,0)),
        radial-gradient(560px 360px at 78% 18%, rgba(225,29,46,0.12), rgba(0,0,0,0)),
        radial-gradient(600px 380px at 72% 82%, rgba(255,42,60,0.10), rgba(0,0,0,0));
      filter: blur(18px);
      animation: drift 9s ease-in-out infinite alternate;
      opacity:0.92;
    }
    @keyframes drift{
      from{ transform: translate3d(-2%, -1%, 0) scale(1.02) }
      to  { transform: translate3d( 2%,  1%, 0) scale(1.07) }
    }

    .sparks{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0.45;
      mix-blend-mode: screen;
      background:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(2px 2px at 30% 40%, rgba(255,42,60,0.55), transparent 60%),
        radial-gradient(2px 2px at 55% 30%, rgba(255,255,255,0.28), transparent 60%),
        radial-gradient(2px 2px at 70% 55%, rgba(255,42,60,0.45), transparent 60%),
        radial-gradient(2px 2px at 85% 25%, rgba(255,255,255,0.25), transparent 60%),
        radial-gradient(2px 2px at 20% 75%, rgba(255,42,60,0.40), transparent 60%),
        radial-gradient(2px 2px at 90% 80%, rgba(255,255,255,0.22), transparent 60%);
      animation: sparkMove 7s linear infinite;
      filter: blur(0.2px);
    }
    @keyframes sparkMove{
      0%{ transform: translateY(0px); }
      100%{ transform: translateY(40px); }
    }

    .wrap{ width:min(1280px, 94vw); padding:24px; position:relative; z-index:1; }

    .card{
      background: linear-gradient(180deg, rgba(17,20,24,0.92), rgba(10,12,15,0.88));
      border: 1px solid rgba(225,29,46,0.30);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 70px rgba(0,0,0,0.65);

      opacity: 1;
      transform: none;

      animation: cardIn 700ms ease;
      position:relative;
      overflow:hidden;
    }
    @keyframes cardIn{ to { transform: translateY(0); opacity:1; } }

    .card::after{
      content:"";
      position:absolute;
      top:-60%;
      left:-40%;
      width:70%;
      height:200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
      transform: rotate(18deg);
      animation: sweep 5.2s ease-in-out infinite;
      opacity:0.55;
      pointer-events:none;
    }
    @keyframes sweep{
      0% { transform: translateX(-120%) rotate(18deg); opacity:0; }
      18%{ opacity:0.55; }
      45%{ opacity:0.55; }
      70%{ opacity:0; }
      100%{ transform: translateX(280%) rotate(18deg); opacity:0; }
    }

    .header{
      display:flex;
      align-items:center;
      gap:14px;
      padding: 6px 6px 12px 6px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 12px;
      position:relative;
      z-index:2;
    }

    .logo{
      width:58px;height:58px;border-radius:999px;
      border:2px solid rgba(225,29,46,0.60);
      box-shadow: 0 0 22px rgba(225,29,46,0.28);
      background: rgba(0,0,0,0.3);
      object-fit: cover;
      animation: logoBreathe 2.8s ease-in-out infinite;
    }
    @keyframes logoBreathe{
      0%,100%{ transform: scale(0.98); box-shadow: 0 0 18px rgba(225,29,46,0.18); }
      50%     { transform: scale(1.01); box-shadow: 0 0 30px rgba(255,42,60,0.32); }
    }

    .titles{ flex:1; min-width:0; }
    h1{
      margin:0;
      font-size: clamp(20px, 2.5vw, 34px);
      letter-spacing:0.6px;
      line-height:1.1;
    }
    .subrow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
    }

    .screenTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 12px 6px 10px 6px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.26);
      position:relative;
      overflow:hidden;
      z-index:2;
    }
    .screenTitle::before{
      content:"";
      position:absolute;
      inset:0;
      opacity:0.18;
      background: radial-gradient(700px 240px at 18% 20%, rgba(255,42,60,0.75), transparent);
      pointer-events:none;
    }
    .screenLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .screenIcon{
      width:36px;height:36px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      flex:0 0 auto;
      box-shadow: 0 0 22px rgba(255,42,60,0.12);
    }
    .screenName{
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: clamp(16px, 1.8vw, 22px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .screenHint{
      color:var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }

    .progressOuter{
      height: 6px;
      border-radius: 999px;
      margin: 0 6px 14px 6px;
      background: rgba(255,255,255,0.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.08);
      position:relative;
      z-index:2;
    }
    .progressInner{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,0), var(--accent2), rgba(255,255,255,0));
      filter: brightness(1.05);
      box-shadow: 0 0 20px rgba(255,42,60,0.24);
    }

    #content.fadeSwap{ animation: fadeSwap 420ms ease; }
    @keyframes fadeSwap{
      0%{ opacity:0; transform: translateY(8px); }
      100%{ opacity:1; transform: translateY(0); }
    }

    .spotlight{
      margin: 0 6px 12px 6px;
      border-radius: 16px;
      border: 1px solid rgba(247,201,72,0.25);
      background: linear-gradient(180deg, rgba(247,201,72,0.10), rgba(0,0,0,0.16));
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      overflow:hidden;
      position:relative;
      z-index:2;
    }
    .spotlight::after{
      content:"";
      position:absolute;
      top:-60%;
      left:-40%;
      width:60%;
      height:200%;
      background: linear-gradient(90deg, transparent, rgba(247,201,72,0.16), transparent);
      transform: rotate(18deg);
      animation: sweepGold 4.8s ease-in-out infinite;
      opacity:0.75;
      pointer-events:none;
    }
    @keyframes sweepGold{
      0% { transform: translateX(-140%) rotate(18deg); opacity:0; }
      22%{ opacity:0.75; }
      55%{ opacity:0.75; }
      80%{ opacity:0; }
      100%{ transform: translateX(320%) rotate(18deg); opacity:0; }
    }

    .spotBadge{
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      white-space:nowrap;
    }
    .crown{
      width:30px;height:30px;border-radius: 12px;
      display:flex;align-items:center;justify-content:center;
      border: 1px solid rgba(247,201,72,0.30);
      background: rgba(0,0,0,0.18);
      box-shadow: 0 0 24px rgba(247,201,72,0.12);
      font-size: 16px;
    }
    .spotList{
      display:flex; gap:12px; flex:1; min-width:0;
    }
    .spotChip{
      flex:1;
      min-width: 0;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .spotChip strong{
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .spotChip span{
      color: var(--muted);
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      position:relative;
      z-index:2;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      letter-spacing:0.14em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 12px 12px;
      background: linear-gradient(180deg, rgba(225,29,46,0.18), rgba(0,0,0,0.12));
      border-bottom: 1px solid rgba(225,29,46,0.25);
    }
    tbody td{
      padding: 12px 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      font-size: clamp(15px, 1.45vw, 18px);
    }
    tbody tr:nth-child(odd){ background: rgba(255,255,255,0.03); }
    tbody tr{
      opacity:0;
      transform: translateY(8px);
      animation: rowIn 420ms ease forwards;
    }
    @keyframes rowIn{ to { opacity:1; transform: translateY(0); } }

    .pos{ width: 92px; color: var(--accent2); font-weight: 950; }
    .name{ font-weight: 750; }
    .score{ width: 110px; text-align:right; font-variant-numeric: tabular-nums; font-weight: 950; }
    tbody tr.top3{
      background: linear-gradient(90deg, rgba(255,42,60,0.12), rgba(255,255,255,0.02));
    }
    .pulse{ animation: pulse 450ms ease; }
    @keyframes pulse{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.10); text-shadow: 0 0 18px rgba(255,42,60,0.30); }
      100%{ transform: scale(1); }
    }

    .grid4{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin: 0 6px 0 6px;
    }


    .panel{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      overflow:hidden;
      box-shadow: 0 12px 35px rgba(0,0,0,0.35);
      position:relative;
    }

    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      position:relative;
    }
    .panelTitle{
      font-weight: 950;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.86);
    }
    .pill{
      font-weight: 950;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: var(--muted);
      white-space:nowrap;
    }
    .panelBody{ padding: 10px; }

    /* ===== Rank accent lines ===== */

    /* SILVER */
    .cat1 .panelHeader{
    border-bottom-color: rgba(192,192,192,0.55);
    }
    .cat1 .pill{
    border-color: rgba(192,192,192,0.55);
    color:#fff;
    }

    /* GOLD */
    .cat2 .panelHeader{
    border-bottom-color: rgba(247,201,72,0.55);
    }
    .cat2 .pill{
    border-color: rgba(247,201,72,0.55);
    color:#fff;
    }

    /* DIAMOND */
    .cat3 .panelHeader{
    border-bottom-color: rgba(56,189,248,0.55);
    }
    .cat3 .pill{
    border-color: rgba(56,189,248,0.55);
    color:#fff;
    }

    /* CHAMPION */
    .cat4 .panelHeader{
    border-bottom-color: rgba(255,42,60,0.65);
    }
    .cat4 .pill{
    border-color: rgba(255,42,60,0.65);
    color:#fff;
    }


    /* Champion stands out (reuse acePanel style) */
    .acePanel{
      border-color: rgba(255,42,60,0.55);
      box-shadow: 0 14px 46px rgba(255,42,60,0.18), 0 14px 46px rgba(0,0,0,0.35);
      transform: translateY(-2px);
    }
    .acePanel::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 18px;
      padding:2px;
      background: linear-gradient(135deg,
        rgba(255,42,60,0.0),
        rgba(255,42,60,0.65),
        rgba(255,255,255,0.10),
        rgba(255,42,60,0.65),
        rgba(255,42,60,0.0)
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      animation: aceGlow 2.6s ease-in-out infinite;
      opacity:0.9;
      pointer-events:none;
    }
    @keyframes aceGlow{
      0%,100%{ filter: blur(0px); opacity:0.65; }
      50%{ filter: blur(0.6px); opacity:1; }
    }

    .aceHeaderLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .aceMark{
      width:28px;height:28px;border-radius: 10px;
      display:flex;align-items:center;justify-content:center;
      border: 1px solid rgba(255,42,60,0.55);
      background: rgba(0,0,0,0.18);
      box-shadow: 0 0 22px rgba(255,42,60,0.20);
      font-size: 15px;
    }
    .aceSub{
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.82);
    }

    .mini thead th{ padding: 10px 10px; font-size: 11px; }
    .mini tbody td{ padding: 10px 10px; font-size: clamp(14px, 1.25vw, 16px); }
    .mini .pos{ width: 72px; }
    .mini .score{ width: 88px; }

    .hint{
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      padding: 0 6px;
      line-height: 1.35;
      position:relative;
      z-index:2;
    }
    code{ color:#fff; }

    @media (max-width: 980px){
      .grid3{ grid-template-columns: 1fr; }
      body{ overflow:auto; }
    }

    .leaderFlash{ animation: flash 520ms ease; }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 rgba(255,42,60,0.0); }
      30%{ box-shadow: 0 0 65px rgba(255,42,60,0.22); }
      100%{ box-shadow: 0 0 0 rgba(255,42,60,0.0); }
    }
    /* ===== Duel Modal ===== */
    #duelModal{
      position:fixed;
      inset:0;
      z-index:9999;
    }
    .duelBackdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,0.70);
      backdrop-filter: blur(4px);
    }
    .duelCard{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%, -50%);
      width: min(720px, 92vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(17,20,24,0.96), rgba(10,12,15,0.92));
      box-shadow: 0 24px 90px rgba(0,0,0,0.65);
      padding: 14px;
      overflow:hidden;
    }
    .duelHr{
    border: none;
    height: 1px;
    background: rgba(255,255,255,0.10);
    margin: 10px 6px;
    }
    .duelTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 6px 12px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }
    .duelTitle{
      font-weight: 950;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 14px;
    }
    .duelClose{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.30);
      color:#fff;
      border-radius: 12px;
      width:40px; height:36px;
      cursor:pointer;
    }
    .duelGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px 6px;
    }
    .duelLabel{
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    #duelA, #duelB{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.28);
      color:#fff;
      font-weight: 800;
    }
    .duelActions{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      padding: 0 6px 12px 6px;
    }
    .duelBtn{
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color:#fff;
      font-weight: 950;
      letter-spacing: .08em;
      text-transform: uppercase;
      cursor:pointer;
    }
    .duelBtn.win{
      border-color: rgba(255,42,60,0.35);
      box-shadow: 0 0 22px rgba(255,42,60,0.12);
    }
    .duelBtn.draw{
      border-color: rgba(247,201,72,0.25);
    }
    .duelNote{
      padding: 0 6px 10px 6px;
      color: var(--muted);
      font-size: 13px;
    }
    @media (max-width: 760px){
      .duelGrid{ grid-template-columns: 1fr; }
      .duelActions{ grid-template-columns: 1fr; }
    }

  </style>
</head>

<body>
  <div class="energy"></div>
  <div class="sparks"></div>

  <div class="wrap">
    <div class="card" id="card">

      <div class="header">
        <img class="logo" src="acekendologo.png" alt="ACE Kendo Academy logo" />
        <div class="titles">
          <h1>ACE Kendo Academy Leaderboards</h1>
          <div class="subrow">
            <div id="smallTag">standings display</div>
            <div id="updatedText">Last updated: ‚Äî</div>
          </div>
        </div>
      </div>

      <div class="screenTitle" id="screenTitle">
        <div class="screenLeft">
          <div class="screenIcon" id="screenIcon">üèÜ</div>
          <div class="screenName" id="screenName">OVERALL DOJO LEADERBOARD</div>
        </div>
        <div class="screenHint" id="screenHint">Auto-rotating</div>
      </div>

      <div class="progressOuter">
        <div class="progressInner" id="progressInner"></div>
      </div>

      <div id="content"></div>

      <div class="hint">
        Keys: <b>N</b> next (Îã§Ïùå), <b>P</b> previous (Ïù¥Ï†Ñ), <b>Space</b> pause (Ï†ïÏßÄ) / resume (Ïû¨Í∞ú)<b>, <b>M</b> Menu (Î©îÎâ¥)<br/>
      </div>

    </div>
  </div>
  <div id="duelModal" style="display:none;">
      <div class="duelBackdrop"></div>
      <div class="duelCard">
        <div class="duelTop">
          <div class="duelTitle">‚öîÔ∏è Start a Duel</div>
          <button class="duelClose" id="duelCloseBtn">‚úï</button>
        </div>

        <div class="duelGrid">
          <div>
            <div class="duelLabel">Fighter A</div>
            <select id="duelA"></select>
          </div>
          <div>
            <div class="duelLabel">Fighter B</div>
            <select id="duelB"></select>
          </div>
        </div>

        <div class="duelActions">
          <button class="duelBtn win" id="aWinBtn">A Wins</button>
          <button class="duelBtn draw" id="drawBtn">Draw</button>
          <button class="duelBtn win" id="bWinBtn">B Wins</button>
        </div>

        <div class="duelNote" id="duelNote">
          Points: Win = +5, Loss and Draw = 0
        <hr class="duelHr"/>

        <div class="duelTitle" style="padding: 6px 6px 10px 6px;">üèÖ Competition Points</div>

        <div class="duelGrid">
        <div>
            <div class="duelLabel">Student</div>
            <select id="compPlayer"></select>
        </div>

        <div>
            <div class="duelLabel">Competition Type (ÎåÄÌöå Ïú†Ìòï)</div>
            <select id="compType">
            <option value="ACE">Ace Kendo Competition</option>
            <option value="RN">Regional / National Competition</option>
            </select>
        </div>
        </div>

        <div class="duelGrid">
        <div>
            <div class="duelLabel">Attendance / Placement (Ï∞∏ÏÑù / ÏàúÏúÑ)</div>
            <select id="compPlace">
            <option value="PART">Participation (Ï∞∏Í∞Ä)</option>
            <option value="1">1st Place</option>
            <option value="2">2nd Place</option>
            <option value="3">3rd Place</option>
            </select>
        </div>

        <div>
            <div class="duelLabel">Matches Won (ÏäπÎ¶¨Ìïú Í≤ΩÍ∏∞ Ïàò)</div>
            <input id="compWins" type="number" min="0" step="1" value="0"
                style="width:100%; padding:12px 12px; border-radius:14px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.28); color:#fff; font-weight:800;" />
        </div>
        </div>

        <div class="duelGrid">
        <div style="display:flex; align-items:center; gap:10px; padding: 6px;">
            <input id="compTeam" type="checkbox" />
            <div style="color: var(--muted); font-size: 13px;">Team Match (Regional/National only)</div>
        </div>
        <div></div>
        </div>

        <div class="duelActions">
        <button class="duelBtn win" id="compApplyBtn">Apply (Ï†êÏàò Ï†ÅÏö©)</button>
        <button class="duelBtn draw" id="compResetBtn">Reset (Ï¥àÍ∏∞Ìôî)</button>
        <button class="duelBtn" id="compPreviewBtn">Preview</button>
        </div>

        <div class="duelNote" id="compNote">
        Set competition type, placement, wins, then Apply. No points are deducted.
        </div>
      </div>
    </div>
  <script>
    // =============================
    // 0) CONFIG
    // =============================
    const DIVISIONS = [
    "Children & Youth",
    "Junior Teens",
    "Senior Teens",
    "Adults"
    ];


    // Ranked game tiers
    const RANKS = ["Silver", "Gold", "Diamond", "Champion"];

    // Overall shows only top 10
    const TOP_N = 10;
    
    const GOLD_AT = 50;
    const DIAMOND_AT = 100;
    const CHAMPION_AT = 250;


    const ROTATE_MS = 9000;

    const VIEWS = [
    { type:"overall" },
    { type:"division", division:"Children & Youth" },
    { type:"division", division:"Junior Teens" },
    { type:"division", division:"Senior Teens" },
    { type:"division", division:"Adults" },
    ];


    const DIV_META = {
    "Children & Youth": {
        icon:"üßí",
        accent:"var(--kids)",
        title:"CHILDREN & YOUTH DIVISION",
        subtitle:"Ages 6‚Äì8"
    },
    "Junior Teens": {
        icon:"üßë‚Äçüéí",
        accent:"var(--teens)",
        title:"JUNIOR TEENS DIVISION",
        subtitle:"Ages 9‚Äì12"
    },
    "Senior Teens": {
        icon:"üßë‚Äçüéì",
        accent:"var(--teens)",
        title:"SENIOR TEENS DIVISION",
        subtitle:"Ages 12‚Äì15"
    },
    "Adults": {
        icon:"üßë‚Äçüíº",
        accent:"var(--adults)",
        title:"ADULTS DIVISION",
        subtitle:"16+"
    },
    };


    // Reuse cat1/cat2/cat3 styling classes
    const RANK_META = {
    "Silver":   { label:"Silver Rank",   className:"cat1" },
    "Gold":     { label:"Gold Rank",     className:"cat2" },
    "Diamond":  { label:"Diamond Rank",  className:"cat3" },
    "Champion": { label:"Champion Rank", className:"cat4" },
    };

    // Optional: migration from old categories -> ranks
    function migrateCategoryToRank(oldCategory){
      if (oldCategory === "ACE") return "Champion";
      if (oldCategory === "Blue-Red") return "Gold";
      if (oldCategory === "Yellow-Purple") return "Bronze";
      return "Bronze";
    }

    // =============================
    // 1) DATA MODEL (UPDATED: rank instead of category)
    // =============================
    const players = new Map([
      ["Sharif", { score: 0, division: "Adults"}],
      ["Daniel Kim", { score: 0, division: "Adults"}],
      ["Rae Kang", { score: 0, division: "Adults"}],
      ["Ben Yoo", { score: 0, division: "Adults"}],
      ["Chris Hyun", { score: 0, division: "Adults"}],
      ["Kylie Kim", { score: 0, division: "Adults"}],
      ["Emma Shaw", { score: 0, division: "Adults"}],
      ["OP Rahul", { score: 0, division: "Adults"}],
      ["Dominic Francesco", { score: 0, division: "Adults"}],
      ["Sallie Kim", { score: 0, division: "Adults"}],

      ["Ian Kim", { score: 0, division: "Junior Teens"}],
      ["Nathan Kim", { score: 0, division: "Senior Teens"}],
      ["Joseph Yoon", { score: 0, division: "Junior Teens"}],
      ["Arie Milne", { score: 0, division: "Senior Teens"}],
      ["Derrick No", { score: 0, division: "Junior Teens"}],
      ["Jaehyun", { score: 0, division: "Senior Teens"}],
      ["Jaesang Lee", { score: 0, division: "Junior Teens"}],
      ["Dominic Peters", { score: 0, division: "Senior Teens"}],
      ["Cooper Simonich", { score: 0, division: "Junior Teens"}],
      ["Dana", { score: 0, division: "Senior Teens"}],
      ["Daniel Jang", { score: 0, division: "Junior Teens"}],
      ["Rook Hamblin", { score: 0, division: "Senior Teens"}],
      ["Luke Um", { score: 0, division: "Junior Teens"}],

      ["Ezekiel Kim", { score: 0, division: "Children & Youth"}],
      ["Bennet Kuan", { score: 0, division: "Children & Youth"}],
      ["Colin Kim", { score: 0, division: "Children & Youth"}],
      ["Asher Rahul", { score: 0, division: "Children & Youth"}],
      ["Alec Rodriguez", { score: 0, division: "Children & Youth"}],
      ["Joshua Kosta", { score: 0, division: "Children & Youth"}],
      ["Elias Escobar", { score: 0, division: "Children & Youth"}],
      ["Arthur Shortt", { score: 0, division: "Children & Youth"}],
      ["Connor Peacock", { score: 0, division: "Children & Youth"}],
    ]);

    const lastScores = new Map([...players.entries()].map(([n, p]) => [n, p.score]));
    let lastLeaderName = null;

    // =============================
    // 2) PERSISTENCE
    // =============================
    const STORAGE_KEY = "ace_leaderboards_v5_ranked";
    
    function rankFromScore(score){
    score = Number(score) || 0;
    if (score >= CHAMPION_AT) return "Champion";
    if (score >= DIAMOND_AT) return "Diamond";
    if (score >= GOLD_AT) return "Gold";
    return "Silver";
    }



    function saveState(){
    const cleanPlayers = [...players.entries()].map(([name, p]) => ([
        name,
        {
        score: Number(p?.score) || 0,
        division: DIVISIONS.includes(p?.division) ? p.division : DIVISIONS[0],
        rank: rankFromScore(Number(p?.score) || 0),
        }
    ]));

    const data = { players: cleanPlayers, updatedAt: Date.now() };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }


   function loadState(){
    // Try newest key first, then fall back to old key (migration)
    let raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) raw = localStorage.getItem("ace_leaderboards_v4");

    try{
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (!data?.players || !Array.isArray(data.players)) return false;

        players.clear();
        lastScores.clear();

        for (const [name, p] of data.players){
        const safeName = String(name).trim();
        if (!safeName) continue;

        const score = Number(p?.score) || 0;
        const division = DIVISIONS.includes(p?.division) ? p.division : DIVISIONS[0];

        // Rank is ALWAYS derived from score thresholds (150/250)
        const rank = rankFromScore(score);

        players.set(safeName, { score, division, rank });
        lastScores.set(safeName, score);
        }

        return true;
    }catch(e){
        console.warn("Could not load saved leaderboard:", e);
        return false;
    }
    }





    // =============================
    // 3) PLAYER + SCORE FUNCTIONS
    // =============================
    function addPlayer(name, division = DIVISIONS[0], startingScore = 0){
      name = String(name).trim();
      if (!name) return console.warn("Player name cannot be empty.");
      if (players.has(name)) return console.warn(`Player "${name}" already exists.`);
      if (!DIVISIONS.includes(division)) return console.warn(`Unknown division "${division}".`);

      const score = Number(startingScore) || 0;
      const rank = rankFromScore(score);
      players.set(name, { score, division, rank });

      lastScores.set(name, score);
      saveState(); render();
    }


    function removePlayer(name){
      if (!players.has(name)) return console.warn(`Player "${name}" does not exist.`);
      players.delete(name);
      lastScores.delete(name);
      saveState(); render();
    }

    function renamePlayer(oldName, newName){
      if (!players.has(oldName)) return console.warn(`Player "${oldName}" does not exist.`);
      newName = String(newName).trim();
      if (!newName) return console.warn("New name cannot be empty.");
      if (players.has(newName)) return console.warn(`Player "${newName}" already exists.`);

      const p = players.get(oldName);
      players.delete(oldName);
      lastScores.delete(oldName);

      players.set(newName, p);
      lastScores.set(newName, p.score);
      saveState(); render();
    }

    function movePlayer(name, division){
      const p = players.get(name);
      if (!p) return console.warn(`Player "${name}" does not exist.`);
      if (!DIVISIONS.includes(division)) return console.warn(`Unknown division "${division}".`);

      p.division = division;
      p.rank = rankFromScore(p.score);
      players.set(name, p);
      saveState(); render();
    }


    function clearLeaderboard(){
      players.clear();
      lastScores.clear();
      saveState(); render();
    }



    function setScore(name, score){
      const p = players.get(name);
      if (!p) return console.warn(`Player "${name}" does not exist.`);

      p.score = Number(score) || 0;
      p.rank = rankFromScore(p.score);

      players.set(name, p);
      saveState(); render();
    }


    function addScore(name, delta){
      const p = players.get(name);
      if (!p) return console.warn(`Player "${name}" does not exist.`);

      p.score = (p.score || 0) + (Number(delta) || 0);
      if (p.score < 0) p.score = 0; // optional: never below 0
      p.rank = rankFromScore(p.score);

      players.set(name, p);
      saveState(); render();
    }


    function resetAllScores(){
      for (const [name, p] of players.entries()){
        p.score = 0;
        p.rank = rankFromScore(0);
        players.set(name, p);
        lastScores.set(name, 0);
      }
      saveState(); render();
    }

    

    function applyDuelResult(nameA, nameB, result){
    // result: "A_WIN" | "B_WIN" | "DRAW"
    const pA = players.get(nameA);
    const pB = players.get(nameB);

    if (!pA || !pB) return console.warn("Invalid duel players.");
    if (nameA === nameB) return console.warn("Pick two different players.");

    const WIN_POINTS = 5;

    if (result === "A_WIN"){
        pA.score = (pA.score || 0) + WIN_POINTS;
    }
    else if (result === "B_WIN"){
        pB.score = (pB.score || 0) + WIN_POINTS;
    }
    // DRAW ‚Üí no points for either

    // Ranks always derived from score
    pA.rank = rankFromScore(pA.score);
    pB.rank = rankFromScore(pB.score);

    players.set(nameA, pA);
    players.set(nameB, pB);

    saveState();
    render();
    }



    window.addPlayer = addPlayer;
    window.removePlayer = removePlayer;
    window.renamePlayer = renamePlayer;
    window.movePlayer = movePlayer;
    window.clearLeaderboard = clearLeaderboard;
    window.setScore = setScore;
    window.addScore = addScore;
    window.resetAllScores = resetAllScores;

    // =============================
    // 4) ROTATION + RENDERING
    // =============================
    let viewIndex = 0;
    let rotateTimer = null;
    let isPaused = false;
    let lastRotateAt = performance.now();

    const updatedText = document.getElementById("updatedText");
    const contentEl = document.getElementById("content");
    const screenIconEl = document.getElementById("screenIcon");
    const screenNameEl = document.getElementById("screenName");
    const screenHintEl = document.getElementById("screenHint");
    const progressInner = document.getElementById("progressInner");
    const cardEl = document.getElementById("card");

    function currentView(){ return VIEWS[viewIndex % VIEWS.length]; }

    function sortEntries(list){
      return list.sort((a,b) => {
        const sa = a[1].score || 0;
        const sb = b[1].score || 0;
        if (sb !== sa) return sb - sa;
        return a[0].localeCompare(b[0]);
      });
    }

    function nonZeroEntries(list){
    return list.filter(([_, p]) => (Number(p?.score) || 0) > 0);
    }


    function overallTop3(){
      const entries = sortEntries(nonZeroEntries([...players.entries()]));
      return entries.slice(0, 3);
    }

    function makeSpotlightBar(){
      const top3 = overallTop3();
      const bar = document.createElement("div");
      bar.className = "spotlight";
      bar.innerHTML = `
        <div class="spotBadge"><div class="crown">üëë</div> OVERALL SPOTLIGHT</div>
        <div class="spotList"></div>
      `;

      const list = bar.querySelector(".spotList");
      const labels = ["#1", "#2", "#3"];

      for (let i=0;i<3;i++){
        const item = top3[i];
        const name = item ? item[0] : "‚Äî";
        const score = item ? (item[1].score || 0) : "‚Äî";
        const chip = document.createElement("div");
        chip.className = "spotChip";
        chip.innerHTML = `<strong>${labels[i]} ${name}</strong><span>${score}</span>`;
        list.appendChild(chip);
      }
      return bar;
    }

    function makeTable(entries, mini=false){
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Pos</th>
          <th>Name</th>
          <th style="text-align:right;">Score</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      if (entries.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="pos">‚Äî</td><td class="name">No players yet</td><td class="score">‚Äî</td>`;
        tbody.appendChild(tr);
      } else {
        entries.forEach(([name, p], idx) => {
          const tr = document.createElement("tr");
          tr.style.animationDelay = `${idx * (mini ? 45 : 60)}ms`;
          if (idx < 3) tr.classList.add("top3");

          const prev = lastScores.get(name);
          const scoreNow = p.score || 0;

          tr.innerHTML = `
            <td class="pos">#${idx + 1}</td>
            <td class="name">${name}</td>
            <td class="score">${scoreNow}</td>
          `;

          if (prev !== undefined && prev !== scoreNow){
            const scoreCell = tr.querySelector(".score");
            if (scoreCell) scoreCell.classList.add("pulse");
          }
          lastScores.set(name, scoreNow);

          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody);
      if (mini) table.classList.add("mini");
      return table;
    }

    function leaderHypeCheck(){
      const top = overallTop3()[0];
      const leader = top ? top[0] : null;
      if (leader && leader !== lastLeaderName){
        lastLeaderName = leader;
        cardEl.classList.remove("leaderFlash");
        void cardEl.offsetWidth;
        cardEl.classList.add("leaderFlash");
      }
    }

    function renderOverall(){
    screenIconEl.textContent = "üèÜ";
    screenNameEl.textContent = "OVERALL DOJO LEADERBOARD";
    screenHintEl.textContent = `Top ${TOP_N} overall`;

    const entries = sortEntries(nonZeroEntries([...players.entries()])).slice(0, TOP_N);

    contentEl.innerHTML = "";
    contentEl.appendChild(makeSpotlightBar());
    contentEl.appendChild(makeTable(entries));
    }


    function renderDivision(division){
      const meta = DIV_META[division] || { icon:"‚öîÔ∏è", accent:"var(--accent2)", title: division.toUpperCase() };

      screenIconEl.textContent = meta.icon;
      screenNameEl.textContent = meta.title;
      screenHintEl.textContent = meta.subtitle || "Silver ‚Ä¢ Gold ‚Ä¢ Diamond ‚Ä¢ Champion";

      contentEl.innerHTML = "";
      contentEl.appendChild(makeSpotlightBar());

      const grid = document.createElement("div");
      grid.className = "grid4";

      for (const rank of RANKS){
        const rMeta = RANK_META[rank];

        const panel = document.createElement("div");
        panel.className = `panel ${rMeta.className} ${rank === "Champion" ? "acePanel" : ""}`;

        const header = document.createElement("div");
        header.className = "panelHeader";

        if (rank === "Champion") {
          header.innerHTML = `
            <div class="aceHeaderLeft">
              <div class="aceMark">üèÜ</div>
              <div>
                <div class="panelTitle">CHAMPION TIER</div>
                <div class="aceSub">Top ranked fighters</div>
              </div>
            </div>
            <div class="pill">${rMeta.label}</div>
          `;
        } else {
          header.innerHTML = `
            <div class="panelTitle">RANK</div>
            <div class="pill">${rMeta.label}</div>
          `;
        }

        const body = document.createElement("div");
        body.className = "panelBody mini";

        const entries = sortEntries(
        nonZeroEntries([...players.entries()])
            .filter(([_, p]) => p.division === division && p.rank === rank)
        );


        body.appendChild(makeTable(entries, true));

        panel.appendChild(header);
        panel.appendChild(body);
        grid.appendChild(panel);
      }

      contentEl.appendChild(grid);
    }

    function render(){
      contentEl.classList.remove("fadeSwap");
      void contentEl.offsetWidth;
      contentEl.classList.add("fadeSwap");

      const v = currentView();
      if (v.type === "overall") renderOverall();
      if (v.type === "division") renderDivision(v.division);

      updatedText.textContent = `Last updated: ${new Date().toLocaleString()}`;
      leaderHypeCheck();
    }

    function goToView(idx){
      viewIndex = ((idx % VIEWS.length) + VIEWS.length) % VIEWS.length;
      lastRotateAt = performance.now();
      render();
    }
    function nextView(){ goToView(viewIndex + 1); }
    function prevView(){ goToView(viewIndex - 1); }

    function startRotation(){
      //stopRotation();
      //lastRotateAt = performance.now();
      //rotateTimer = setInterval(() => {
      //  if (!isPaused) nextView();
      //}, ROTATE_MS);
    }
    function stopRotation(){
      //if (rotateTimer) clearInterval(rotateTimer);
      //rotateTimer = null;
    }
    function togglePause(){
      isPaused = !isPaused;
      screenHintEl.textContent = isPaused ? "Paused (press Space to resume)" : "Auto-rotating";
      lastRotateAt = performance.now();
    }

    function tick(){
      const now = performance.now();

      if (!isPaused){
        const elapsed = now - lastRotateAt;
        const pct = Math.min(100, (elapsed / ROTATE_MS) * 100);
        progressInner.style.width = pct + "%";

        // ‚úÖ When timer hits ROTATE_MS, advance view
        if (elapsed >= ROTATE_MS){
          nextView();                 // goToView() resets lastRotateAt
          // Safety: if nextView didn't reset it for any reason:
          lastRotateAt = performance.now();
        }
      } else {
        progressInner.style.width = "0%";
      }

      requestAnimationFrame(tick);
    }


    window.addEventListener("keydown", (e) => {
      if (e.code === "KeyN") { e.preventDefault(); nextView(); }
      if (e.code === "KeyP") { e.preventDefault(); prevView(); }
      if (e.code === "Space") { e.preventDefault(); togglePause(); }
    });

    loadState();
    render();
    startRotation(); // harmless now
    tick();          // REQUIRED

    

    // =============================
    // 6) DUEL MENU (press M)
    // =============================
    const duelModal = document.getElementById("duelModal");
    const duelA = document.getElementById("duelA");
    const duelB = document.getElementById("duelB");
    const duelCloseBtn = document.getElementById("duelCloseBtn");

    const aWinBtn = document.getElementById("aWinBtn");
    const bWinBtn = document.getElementById("bWinBtn");
    const drawBtn = document.getElementById("drawBtn");

    function isDuelOpen(){
      return duelModal.style.display !== "none";
    }

    function openDuel(){
    // build dropdown options sorted by name
    const names = [...players.keys()].sort((a,b)=>a.localeCompare(b));

    const optionsHTML = names.map(n => `<option value="${n}">${n}</option>`).join("");

    duelA.innerHTML = optionsHTML;
    duelB.innerHTML = optionsHTML;

    // ‚úÖ Competition dropdown (make sure you have <select id="compPlayer"></select>)
    if (typeof compPlayer !== "undefined" && compPlayer){
        compPlayer.innerHTML = optionsHTML;
    }

    // default selections if possible
    if (names.length >= 2){
        duelA.value = names[0];
        duelB.value = names[1];
        if (compPlayer) compPlayer.value = names[0];
    } else if (names.length === 1){
        duelA.value = names[0];
        duelB.value = names[0];
        if (compPlayer) compPlayer.value = names[0];
    }

    // ‚úÖ Reset competition inputs + preview text (only if you added that function)
    if (typeof resetCompetitionForm === "function"){
        resetCompetitionForm();
    } else if (typeof updateCompUI === "function"){
        updateCompUI();
    }

    duelModal.style.display = "block";
    }


    function closeDuel(){
      duelModal.style.display = "none";
    }

    function submitDuel(result){
      const a = duelA.value;
      const b = duelB.value;
      applyDuelResult(a, b, result);
      closeDuel();
    }

    duelCloseBtn.addEventListener("click", closeDuel);
    // close if you click the dark background
    duelModal.addEventListener("click", (e) => {
      if (e.target.classList.contains("duelBackdrop")) closeDuel();
    });

    aWinBtn.addEventListener("click", () => submitDuel("A_WIN"));
    bWinBtn.addEventListener("click", () => submitDuel("B_WIN"));
    drawBtn.addEventListener("click", () => submitDuel("DRAW"));

    // Extend your existing keydown handler:
    window.addEventListener("keydown", (e) => {
      // If duel is open, Esc closes it
      if (isDuelOpen() && e.code === "Escape"){
        e.preventDefault();
        closeDuel();
        return;
      }

      if (e.code === "KeyM"){
        e.preventDefault();
        if (isDuelOpen()) closeDuel();
        else openDuel();
      }
    });
    
    // =============================
    // COMPETITION POINTS (No deductions)
    // =============================
    const compPlayer = document.getElementById("compPlayer");
    const compType = document.getElementById("compType");
    const compPlace = document.getElementById("compPlace");
    const compWins = document.getElementById("compWins");
    const compTeam = document.getElementById("compTeam");

    const compApplyBtn = document.getElementById("compApplyBtn");
    const compResetBtn = document.getElementById("compResetBtn");
    const compPreviewBtn = document.getElementById("compPreviewBtn");
    const compNote = document.getElementById("compNote");

    function pointsForCompetition({ type, place, wins, isTeam }){
    wins = Math.max(0, Number(wins) || 0);

    // Participation is ALWAYS 5 points
    const PARTICIPATION_POINTS = 5;

    // =============================
    // ACE KENDO COMPETITION
    // =============================
    // Participation = 5
    // 1st = 15
    // 2nd = 10
    // 3rd = 5
    // Each match win = 1
    if (type === "ACE"){
        let base = 0;

        if (place === "PART") base = PARTICIPATION_POINTS;
        if (place === "1") base = 15;
        if (place === "2") base = 10;
        if (place === "3") base = 5;

        const winPts = wins * 1;
        return { base, winPts, total: base + winPts };
    }

    // =============================
    // REGIONAL / NATIONAL
    // =============================
    // Participation = 5 (individual or team)
    // INDIVIDUAL:
    //   1st = 20
    //   2nd = 15
    //   3rd = 10
    //   Each match win = 1
    //
    // TEAM:
    //   1st = 30
    //   2nd = 20
    //   3rd = 10
    //   Each match win = 2
    if (type === "RN"){
        let base = 0;

        if (place === "PART") base = PARTICIPATION_POINTS;
        else if (isTeam){
        if (place === "1") base = 30;
        if (place === "2") base = 20;
        if (place === "3") base = 10;
        } else {
        if (place === "1") base = 20;
        if (place === "2") base = 15;
        if (place === "3") base = 10;
        }

        const winPts = wins * (isTeam ? 2 : 1);
        return { base, winPts, total: base + winPts };
    }

    return { base: 0, winPts: 0, total: 0 };
    }


    function updateCompUI(){
    // Only show team option for RN
    const isRN = compType.value === "RN";
    compTeam.disabled = !isRN;
    if (!isRN) compTeam.checked = false;

    const pts = pointsForCompetition({
        type: compType.value,
        place: compPlace.value,
        wins: compWins.value,
        isTeam: compTeam.checked
    });

    const labelType = (compType.value === "ACE") ? "ACE" : "REG/NAT";
    const labelTeam = (compType.value === "RN" && compTeam.checked) ? " ‚Ä¢ TEAM" : "";
    const placementText =
        compPlace.value === "PART" ? "Participation" :
        compPlace.value === "1" ? "1st" :
        compPlace.value === "2" ? "2nd" : "3rd";

    compNote.textContent =
        `${labelType}${labelTeam}: ${placementText} base ${pts.base} + wins ${pts.winPts} = TOTAL +${pts.total} points`;
    }

    function applyCompetitionPoints(){
    const name = compPlayer.value;
    const p = players.get(name);
    if (!p) return console.warn("Invalid competition player.");

    const pts = pointsForCompetition({
        type: compType.value,
        place: compPlace.value,
        wins: compWins.value,
        isTeam: compTeam.checked
    });

    const add = pts.total;
    if (add <= 0){
        // nothing to apply
        updateCompUI();
        return;
    }

    p.score = (p.score || 0) + add;
    p.rank = rankFromScore(p.score);

    players.set(name, p);
    saveState();
    render();

    compNote.textContent = `‚úÖ Added +${add} points to ${name}. New score: ${p.score}`;
    }

    function resetCompetitionForm(){
    compType.value = "ACE";
    compPlace.value = "PART";
    compWins.value = 0;
    compTeam.checked = false;
    updateCompUI();
    }

    // Hook up events
    ["change", "input"].forEach(evt => {
    compType.addEventListener(evt, updateCompUI);
    compPlace.addEventListener(evt, updateCompUI);
    compWins.addEventListener(evt, updateCompUI);
    compTeam.addEventListener(evt, updateCompUI);
    });

    compApplyBtn.addEventListener("click", applyCompetitionPoints);
    compResetBtn.addEventListener("click", resetCompetitionForm);
    compPreviewBtn.addEventListener("click", updateCompUI);




  </script>
</body>
</html>
