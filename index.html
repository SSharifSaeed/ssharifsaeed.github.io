<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACE Kendo Academy Leaderboards</title>

  <style>
    :root{
      --bg:#050607;
      --text:#ffffff;
      --muted:#c9c9c9;

      --accent:#e11d2e;
      --accent2:#ff2a3c;

      --line:rgba(255,255,255,0.10);
      --shadow: rgba(0,0,0,0.65);

      /* Division accents */
      --kids: #ffb020;
      --teens:#7c3aed;
      --adults:#22c55e;

      /* Category accents */
      --cat1:#facc15; /* Yellow-Purple */
      --cat2:#3b82f6; /* Blue-Red */
      --cat3:#ff2a3c; /* ACE */
      --gold:#f7c948;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      height:100vh;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(1200px 700px at 30% 20%, rgba(225,29,46,0.14), rgba(0,0,0,0)),
        radial-gradient(900px 600px at 80% 35%, rgba(225,29,46,0.10), rgba(0,0,0,0)),
        linear-gradient(180deg, #000, var(--bg));
    }

    /* ========= MORE ‚ÄúHYPE‚Äù MOTION ========= */

    /* Slow drifting glow */
    .energy{
      position:fixed; inset:-20%;
      pointer-events:none;
      background:
        radial-gradient(520px 340px at 18% 30%, rgba(255,42,60,0.18), rgba(0,0,0,0)),
        radial-gradient(560px 360px at 78% 18%, rgba(225,29,46,0.12), rgba(0,0,0,0)),
        radial-gradient(600px 380px at 72% 82%, rgba(255,42,60,0.10), rgba(0,0,0,0));
      filter: blur(18px);
      animation: drift 9s ease-in-out infinite alternate;
      opacity:0.92;
    }
    @keyframes drift{
      from{ transform: translate3d(-2%, -1%, 0) scale(1.02) }
      to  { transform: translate3d( 2%,  1%, 0) scale(1.07) }
    }

    /* Sparks layer (CSS-only ‚Äúparticles‚Äù) */
    .sparks{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:0.45;
      mix-blend-mode: screen;
      background:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(2px 2px at 30% 40%, rgba(255,42,60,0.55), transparent 60%),
        radial-gradient(2px 2px at 55% 30%, rgba(255,255,255,0.28), transparent 60%),
        radial-gradient(2px 2px at 70% 55%, rgba(255,42,60,0.45), transparent 60%),
        radial-gradient(2px 2px at 85% 25%, rgba(255,255,255,0.25), transparent 60%),
        radial-gradient(2px 2px at 20% 75%, rgba(255,42,60,0.40), transparent 60%),
        radial-gradient(2px 2px at 90% 80%, rgba(255,255,255,0.22), transparent 60%);
      animation: sparkMove 7s linear infinite;
      filter: blur(0.2px);
    }
    @keyframes sparkMove{
      0%{ transform: translateY(0px); }
      100%{ transform: translateY(40px); }
    }

    .wrap{ width:min(1280px, 94vw); padding:24px; position:relative; z-index:1; }

    .card{
    background: linear-gradient(180deg, rgba(17,20,24,0.92), rgba(10,12,15,0.88));
    border: 1px solid rgba(225,29,46,0.30);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 18px 70px rgba(0,0,0,0.65);

    /* IMPORTANT: always visible even if animations fail */
    opacity: 1;
    transform: none;

    /* optional: keep animation for browsers that support it */
    animation: cardIn 700ms ease;
    position:relative;
    overflow:hidden;
    }

    @keyframes cardIn{ to { transform: translateY(0); opacity:1; } }

    /* subtle moving highlight on the whole card */
    .card::after{
      content:"";
      position:absolute;
      top:-60%;
      left:-40%;
      width:70%;
      height:200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
      transform: rotate(18deg);
      animation: sweep 5.2s ease-in-out infinite;
      opacity:0.55;
      pointer-events:none;
    }
    @keyframes sweep{
      0% { transform: translateX(-120%) rotate(18deg); opacity:0; }
      18%{ opacity:0.55; }
      45%{ opacity:0.55; }
      70%{ opacity:0; }
      100%{ transform: translateX(280%) rotate(18deg); opacity:0; }
    }

    .header{
      display:flex;
      align-items:center;
      gap:14px;
      padding: 6px 6px 12px 6px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 12px;
      position:relative;
      z-index:2;
    }

    .logo{
      width:58px;height:58px;border-radius:999px;
      border:2px solid rgba(225,29,46,0.60);
      box-shadow: 0 0 22px rgba(225,29,46,0.28);
      background: rgba(0,0,0,0.3);
      object-fit: cover;
      animation: logoBreathe 2.8s ease-in-out infinite;
    }
    @keyframes logoBreathe{
      0%,100%{ transform: scale(0.98); box-shadow: 0 0 18px rgba(225,29,46,0.18); }
      50%     { transform: scale(1.01); box-shadow: 0 0 30px rgba(255,42,60,0.32); }
    }

    .titles{ flex:1; min-width:0; }
    h1{
      margin:0;
      font-size: clamp(20px, 2.5vw, 34px);
      letter-spacing:0.6px;
      line-height:1.1;
    }
    .subrow{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      margin-top:6px;
      color:var(--muted);
      font-size:14px;
    }

    /* SCREEN TITLE (big + obvious) */
    .screenTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin: 12px 6px 10px 6px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.26);
      position:relative;
      overflow:hidden;
      z-index:2;
    }
    .screenTitle::before{
      content:"";
      position:absolute;
      inset:0;
      opacity:0.18;
      background: radial-gradient(700px 240px at 18% 20%, rgba(255,42,60,0.75), transparent);
      pointer-events:none;
    }
    .screenLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .screenIcon{
      width:36px;height:36px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      flex:0 0 auto;
      box-shadow: 0 0 22px rgba(255,42,60,0.12);
    }
    .screenName{
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: clamp(16px, 1.8vw, 22px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .screenHint{
      color:var(--muted);
      font-size: 13px;
      white-space:nowrap;
    }

    /* countdown bar to next screen (adds ‚Äúevent‚Äù feel) */
    .progressOuter{
      height: 6px;
      border-radius: 999px;
      margin: 0 6px 14px 6px;
      background: rgba(255,255,255,0.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.08);
      position:relative;
      z-index:2;
    }
    .progressInner{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,255,255,0), var(--accent2), rgba(255,255,255,0));
      filter: brightness(1.05);
      box-shadow: 0 0 20px rgba(255,42,60,0.24);
    }

    #content.fadeSwap{ animation: fadeSwap 420ms ease; }
    @keyframes fadeSwap{
      0%{ opacity:0; transform: translateY(8px); }
      100%{ opacity:1; transform: translateY(0); }
    }

    /* OVERALL SPOTLIGHT BAR (shows top 3 overall on division screens) */
    .spotlight{
      margin: 0 6px 12px 6px;
      border-radius: 16px;
      border: 1px solid rgba(247,201,72,0.25);
      background: linear-gradient(180deg, rgba(247,201,72,0.10), rgba(0,0,0,0.16));
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      overflow:hidden;
      position:relative;
      z-index:2;
    }
    .spotlight::after{
      content:"";
      position:absolute;
      top:-60%;
      left:-40%;
      width:60%;
      height:200%;
      background: linear-gradient(90deg, transparent, rgba(247,201,72,0.16), transparent);
      transform: rotate(18deg);
      animation: sweepGold 4.8s ease-in-out infinite;
      opacity:0.75;
      pointer-events:none;
    }
    @keyframes sweepGold{
      0% { transform: translateX(-140%) rotate(18deg); opacity:0; }
      22%{ opacity:0.75; }
      55%{ opacity:0.75; }
      80%{ opacity:0; }
      100%{ transform: translateX(320%) rotate(18deg); opacity:0; }
    }

    .spotBadge{
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      white-space:nowrap;
    }
    .crown{
      width:30px;height:30px;border-radius: 12px;
      display:flex;align-items:center;justify-content:center;
      border: 1px solid rgba(247,201,72,0.30);
      background: rgba(0,0,0,0.18);
      box-shadow: 0 0 24px rgba(247,201,72,0.12);
      font-size: 16px;
    }
    .spotList{
      display:flex; gap:12px; flex:1; min-width:0;
    }
    .spotChip{
      flex:1;
      min-width: 0;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .spotChip strong{
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .spotChip span{
      color: var(--muted);
      font-weight: 900;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    /* TABLES */
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      position:relative;
      z-index:2;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      letter-spacing:0.14em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 12px 12px;
      background: linear-gradient(180deg, rgba(225,29,46,0.18), rgba(0,0,0,0.12));
      border-bottom: 1px solid rgba(225,29,46,0.25);
    }
    tbody td{
      padding: 12px 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      font-size: clamp(15px, 1.45vw, 18px);
    }
    tbody tr:nth-child(odd){ background: rgba(255,255,255,0.03); }
    tbody tr{
      opacity:0;
      transform: translateY(8px);
      animation: rowIn 420ms ease forwards;
    }
    @keyframes rowIn{ to { opacity:1; transform: translateY(0); } }

    .pos{ width: 92px; color: var(--accent2); font-weight: 950; }
    .name{ font-weight: 750; }
    .score{ width: 110px; text-align:right; font-variant-numeric: tabular-nums; font-weight: 950; }

    tbody tr.top3{
      background: linear-gradient(90deg, rgba(255,42,60,0.12), rgba(255,255,255,0.02));
    }

    .pulse{ animation: pulse 450ms ease; }
    @keyframes pulse{
      0%{ transform: scale(1); }
      45%{ transform: scale(1.10); text-shadow: 0 0 18px rgba(255,42,60,0.30); }
      100%{ transform: scale(1); }
    }

    /* Division 3-column view */
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 0 6px 0 6px;
      position:relative;
      z-index:2;
    }

    .panel{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
      overflow:hidden;
      box-shadow: 0 12px 35px rgba(0,0,0,0.35);
      position:relative;
    }

    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      position:relative;
    }
    .panelTitle{
      font-weight: 950;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,0.86);
    }
    .pill{
      font-weight: 950;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: var(--muted);
      white-space:nowrap;
    }
    .panelBody{ padding: 10px; }

    /* category accent lines */
    .cat1 .panelHeader{ border-bottom-color: rgba(250,204,21,0.35); }
    .cat2 .panelHeader{ border-bottom-color: rgba(59,130,246,0.35); }
    .cat3 .panelHeader{ border-bottom-color: rgba(255,42,60,0.35); }

    .cat1 .pill{ border-color: rgba(250,204,21,0.35); }
    .cat2 .pill{ border-color: rgba(59,130,246,0.35); }
    .cat3 .pill{ border-color: rgba(255,42,60,0.45); color:#fff; }

    /* ====== ACE PANEL STANDS OUT MORE ====== */
    .acePanel{
      border-color: rgba(255,42,60,0.55);
      box-shadow: 0 14px 46px rgba(255,42,60,0.18), 0 14px 46px rgba(0,0,0,0.35);
      transform: translateY(-2px);
    }
    .acePanel::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: 18px;
      padding:2px;
      background: linear-gradient(135deg,
        rgba(255,42,60,0.0),
        rgba(255,42,60,0.65),
        rgba(255,255,255,0.10),
        rgba(255,42,60,0.65),
        rgba(255,42,60,0.0)
      );
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      animation: aceGlow 2.6s ease-in-out infinite;
      opacity:0.9;
      pointer-events:none;
    }
    @keyframes aceGlow{
      0%,100%{ filter: blur(0px); opacity:0.65; }
      50%{ filter: blur(0.6px); opacity:1; }
    }

    .aceHeaderLeft{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .aceMark{
      width:28px;height:28px;border-radius: 10px;
      display:flex;align-items:center;justify-content:center;
      border: 1px solid rgba(255,42,60,0.55);
      background: rgba(0,0,0,0.18);
      box-shadow: 0 0 22px rgba(255,42,60,0.20);
      font-size: 15px;
    }
    .aceSub{
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.82);
    }

    /* mini tables */
    .mini thead th{ padding: 10px 10px; font-size: 11px; }
    .mini tbody td{ padding: 10px 10px; font-size: clamp(14px, 1.25vw, 16px); }
    .mini .pos{ width: 72px; }
    .mini .score{ width: 88px; }

    .hint{
      margin-top: 12px;
      color: var(--muted);
      font-size: 13px;
      padding: 0 6px;
      line-height: 1.35;
      position:relative;
      z-index:2;
    }
    code{ color:#fff; }

    @media (max-width: 980px){
      .grid3{ grid-template-columns: 1fr; }
      body{ overflow:auto; }
    }

    /* small flash when leader changes */
    .leaderFlash{
      animation: flash 520ms ease;
    }
    @keyframes flash{
      0%{ box-shadow: 0 0 0 rgba(255,42,60,0.0); }
      30%{ box-shadow: 0 0 65px rgba(255,42,60,0.22); }
      100%{ box-shadow: 0 0 0 rgba(255,42,60,0.0); }
    }
  </style>
</head>

<body>
  <div class="energy"></div>
  <div class="sparks"></div>

  <div class="wrap">
    <div class="card" id="card">

      <div class="header">
        <img class="logo" src="acekendologo.png" alt="ACE Kendo Academy logo" />
        <div class="titles">
          <h1>ACE Kendo Academy Leaderboards</h1>
          <div class="subrow">
            <div id="smallTag">Rotating standings display</div>
            <div id="updatedText">Last updated: ‚Äî</div>
          </div>
        </div>
      </div>

      <div class="screenTitle" id="screenTitle">
        <div class="screenLeft">
          <div class="screenIcon" id="screenIcon">üèÜ</div>
          <div class="screenName" id="screenName">OVERALL DOJO LEADERBOARD</div>
        </div>
        <div class="screenHint" id="screenHint">Auto-rotating</div>
      </div>

      <div class="progressOuter">
        <div class="progressInner" id="progressInner"></div>
      </div>

      <div id="content"></div>

      <div class="hint">
        Keys: <b>N</b> next, <b>P</b> previous, <b>Space</b> pause/resume.<br/>
        Console:
        <code>addPlayer("Name","Teens","Blue-Red",0)</code>,
        <code>addScore("Name",1)</code>,
        <code>movePlayer("Name","Adults","ACE")</code>,
        <code>removePlayer("Name")</code>
      </div>

    </div>
  </div>

  <script>
    // =============================
    // 0) CONFIG
    // =============================
    const DIVISIONS = ["Children & Youth", "Teens", "Adults"];
    const CATEGORIES = ["Yellow-Purple", "Blue-Red", "ACE"];
    const TOP_N = 10; 
    const ROTATE_MS = 9000;

    // Rotation order: Overall -> Children -> Teens -> Adults -> repeat
    const VIEWS = [
      { type:"overall" },
      { type:"division", division:"Children & Youth" },
      { type:"division", division:"Teens" },
      { type:"division", division:"Adults" },
    ];

    const DIV_META = {
      "Children & Youth": { icon:"üßí", accent:"var(--kids)",  title:"CHILDREN & YOUTH DIVISION", subtitle:"3 category leaderboards side-by-side" },
      "Teens":            { icon:"üßë‚Äçüéì", accent:"var(--teens)", title:"TEENS DIVISION",           subtitle:"3 category leaderboards side-by-side" },
      "Adults":           { icon:"üßë‚Äçüíº", accent:"var(--adults)",title:"ADULTS DIVISION",          subtitle:"3 category leaderboards side-by-side" },
    };

    const CAT_META = {
      "Yellow-Purple": { label:"Yellow ‚Üí Purple Belts", className:"cat1" },
      "Blue-Red":      { label:"Blue ‚Üí Red Belts",      className:"cat2" },
      "ACE":           { label:"ACE Division",          className:"cat3" },
    };

    // =============================
    // 1) DATA MODEL
    // =============================
    const players = new Map([
      ["Sharif", { score: 0, division: "Adults", category: "ACE" }],
      ["Daniel Kim",    { score: 0, division: "Adults",  category: "ACE" }],
      ["Rae Kang",   { score: 0, division: "Adults", category: "ACE" }],
      ["Ben Yoo",   { score: 0, division: "Adults", category: "ACE" }],
      ["Chris Hyun",   { score: 0, division: "Adults", category: "ACE" }],
      ["Kylie Kim",   { score: 0, division: "Adults", category: "ACE" }],
      ["Sallie Kim",   { score: 0, division: "Adults", category: "Yellow-Purple" }],
      ["OP Rahul",   { score: 0, division: "Adults", category: "Blue-Red" }],
      ["Dominic Francesco",   { score: 0, division: "Adults", category: "Blue-Red" }],
      ["Emma Shaw",   { score: 0, division: "Adults", category: "ACE" }],
      ["Ian Kim",   { score: 0, division: "Teens", category: "ACE" }],
      ["Nathan Kim",   { score: 0, division: "Teens", category: "ACE" }],
      ["Ezekiel Kim",   { score: 0, division: "Teens", category: "ACE" }],
      ["Dana",   { score: 0, division: "Teens", category: "Yellow-Purple" }],
      ["Arie Milne",   { score: 0, division: "Teens", category: "Blue-Red" }],
      ["Derrick No",   { score: 0, division: "Teens", category: "Blue-Red" }],
      ["Jaehyun",   { score: 0, division: "Teens", category: "Blue-Red" }],
      ["Jaesang",   { score: 0, division: "Teens", category: "Blue-Red" }],
      ["Elias Escobar",   { score: 0, division: "Children & Youth", category: "Yellow-Purple" }],
      ["Arthur Shortt",   { score: 0, division: "Children & Youth", category: "Yellow-Purple" }],
      ["Connor Peacock",   { score: 0, division: "Children & Youth", category: "Yellow-Purple" }],
      ["Hana",   { score: 0, division: "Children & Youth", category: "Yellow-Purple" }],
      ["Hana",   { score: 0, division: "Children & Youth", category: "Yellow-Purple" }],
      ["Hana",   { score: 0, division: "Children & Youth", category: "Yellow-Purple" }],
      ["Hana",   { score: 0, division: "Children & Youth", category: "Yellow-Purple" }],
    ]);

    const lastScores = new Map([...players.entries()].map(([n, p]) => [n, p.score]));

    // leader tracking for excitement moment
    let lastLeaderName = null;

    // =============================
    // 2) PERSISTENCE
    // =============================
    const STORAGE_KEY = "ace_leaderboards_v4";

    function saveState(){
      const data = { players: [...players.entries()], updatedAt: Date.now() };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (!data?.players || !Array.isArray(data.players)) return false;

        players.clear();
        lastScores.clear();

        for (const [name, p] of data.players){
          const safeName = String(name).trim();
          if (!safeName) continue;

          const score = Number(p?.score) || 0;
          const division = DIVISIONS.includes(p?.division) ? p.division : DIVISIONS[0];
          const category = CATEGORIES.includes(p?.category) ? p.category : CATEGORIES[0];

          players.set(safeName, { score, division, category });
          lastScores.set(safeName, score);
        }
        return true;
      }catch(e){
        console.warn("Could not load saved leaderboard:", e);
        return false;
      }
    }

    // =============================
    // 3) PLAYER + SCORE FUNCTIONS
    // =============================
    function addPlayer(name, division = DIVISIONS[0], category = CATEGORIES[0], startingScore = 0){
      name = String(name).trim();
      if (!name) return console.warn("Player name cannot be empty.");
      if (players.has(name)) return console.warn(`Player "${name}" already exists.`);
      if (!DIVISIONS.includes(division)) return console.warn(`Unknown division "${division}".`);
      if (!CATEGORIES.includes(category)) return console.warn(`Unknown category "${category}".`);

      const score = Number(startingScore) || 0;
      players.set(name, { score, division, category });
      lastScores.set(name, score);
      saveState(); render();
    }

    function removePlayer(name){
      if (!players.has(name)) return console.warn(`Player "${name}" does not exist.`);
      players.delete(name);
      lastScores.delete(name);
      saveState(); render();
    }

    function renamePlayer(oldName, newName){
      if (!players.has(oldName)) return console.warn(`Player "${oldName}" does not exist.`);
      newName = String(newName).trim();
      if (!newName) return console.warn("New name cannot be empty.");
      if (players.has(newName)) return console.warn(`Player "${newName}" already exists.`);

      const p = players.get(oldName);
      players.delete(oldName);
      lastScores.delete(oldName);

      players.set(newName, p);
      lastScores.set(newName, p.score);
      saveState(); render();
    }

    function movePlayer(name, division, category){
      const p = players.get(name);
      if (!p) return console.warn(`Player "${name}" does not exist.`);
      if (!DIVISIONS.includes(division)) return console.warn(`Unknown division "${division}".`);
      if (!CATEGORIES.includes(category)) return console.warn(`Unknown category "${category}".`);

      p.division = division;
      p.category = category;
      players.set(name, p);
      saveState(); render();
    }

    function clearLeaderboard(){
      players.clear();
      lastScores.clear();
      saveState(); render();
    }

    function setScore(name, score){
      const p = players.get(name);
      if (!p) return console.warn(`Player "${name}" does not exist.`);
      p.score = Number(score) || 0;
      players.set(name, p);
      saveState(); render();
    }

    function addScore(name, delta){
      const p = players.get(name);
      if (!p) return console.warn(`Player "${name}" does not exist.`);
      p.score = (p.score || 0) + (Number(delta) || 0);
      players.set(name, p);
      saveState(); render();
    }

    function resetAllScores(){
      for (const [name, p] of players.entries()){
        p.score = 0;
        players.set(name, p);
        lastScores.set(name, 0);
      }
      saveState(); render();
    }

    window.addPlayer = addPlayer;
    window.removePlayer = removePlayer;
    window.renamePlayer = renamePlayer;
    window.movePlayer = movePlayer;
    window.clearLeaderboard = clearLeaderboard;
    window.setScore = setScore;
    window.addScore = addScore;
    window.resetAllScores = resetAllScores;

    // =============================
    // 4) ROTATION + RENDERING
    // =============================
    let viewIndex = 0;
    let rotateTimer = null;
    let isPaused = false;
    let lastRotateAt = performance.now();

    const updatedText = document.getElementById("updatedText");
    const contentEl = document.getElementById("content");
    const screenIconEl = document.getElementById("screenIcon");
    const screenNameEl = document.getElementById("screenName");
    const screenHintEl = document.getElementById("screenHint");
    const progressInner = document.getElementById("progressInner");
    const cardEl = document.getElementById("card");

    function currentView(){ return VIEWS[viewIndex % VIEWS.length]; }

    function sortEntries(list){
      return list.sort((a,b) => {
        const sa = a[1].score || 0;
        const sb = b[1].score || 0;
        if (sb !== sa) return sb - sa;
        return a[0].localeCompare(b[0]);
      });
    }

    function overallTop3(){
      const entries = sortEntries([...players.entries()]);
      return entries.slice(0, 3);
    }

    function makeSpotlightBar(){
      const top3 = overallTop3();
      const bar = document.createElement("div");
      bar.className = "spotlight";
      bar.innerHTML = `
        <div class="spotBadge"><div class="crown">üëë</div> OVERALL SPOTLIGHT</div>
        <div class="spotList"></div>
      `;

      const list = bar.querySelector(".spotList");
      const labels = ["#1", "#2", "#3"];

      for (let i=0;i<3;i++){
        const item = top3[i];
        const name = item ? item[0] : "‚Äî";
        const score = item ? (item[1].score || 0) : "‚Äî";
        const chip = document.createElement("div");
        chip.className = "spotChip";
        chip.innerHTML = `<strong>${labels[i]} ${name}</strong><span>${score}</span>`;
        list.appendChild(chip);
      }
      return bar;
    }

    function makeTable(entries, mini=false){
      const table = document.createElement("table");
      const thead = document.createElement("thead");
      thead.innerHTML = `
        <tr>
          <th>Pos</th>
          <th>Name</th>
          <th style="text-align:right;">Score</th>
        </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      if (entries.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="pos">‚Äî</td><td class="name">No players yet</td><td class="score">‚Äî</td>`;
        tbody.appendChild(tr);
      } else {
        entries.forEach(([name, p], idx) => {
          const tr = document.createElement("tr");
          tr.style.animationDelay = `${idx * (mini ? 45 : 60)}ms`;
          if (idx < 3) tr.classList.add("top3");

          const prev = lastScores.get(name);
          const scoreNow = p.score || 0;

          tr.innerHTML = `
            <td class="pos">#${idx + 1}</td>
            <td class="name">${name}</td>
            <td class="score">${scoreNow}</td>
          `;

          if (prev !== undefined && prev !== scoreNow){
            const scoreCell = tr.querySelector(".score");
            if (scoreCell) scoreCell.classList.add("pulse");
          }
          lastScores.set(name, scoreNow);

          tbody.appendChild(tr);
        });
      }

      table.appendChild(tbody);
      if (mini) table.classList.add("mini");
      return table;
    }

    function leaderHypeCheck(){
      // overall leader only (keeps it simple + exciting)
      const top = overallTop3()[0];
      const leader = top ? top[0] : null;
      if (leader && leader !== lastLeaderName){
        lastLeaderName = leader;
        cardEl.classList.remove("leaderFlash");
        void cardEl.offsetWidth;
        cardEl.classList.add("leaderFlash");
      }
    }

    function renderOverall(){
    screenIconEl.textContent = "üèÜ";
    screenNameEl.textContent = "OVERALL DOJO LEADERBOARD";
    screenHintEl.textContent = "Top 10 overall (everyone)";

    // Top 10 only
    const entries = sortEntries([...players.entries()]).slice(0, TOP_N);

    contentEl.innerHTML = "";
    contentEl.appendChild(makeSpotlightBar());
    contentEl.appendChild(makeTable(entries));
    }


    function renderDivision(division){
      const meta = DIV_META[division] || { icon:"‚öîÔ∏è", accent:"var(--accent2)", title: division.toUpperCase() };

      screenIconEl.textContent = meta.icon;
      screenNameEl.textContent = meta.title;
      screenHintEl.textContent = meta.subtitle || "3 category leaderboards side-by-side";

      contentEl.innerHTML = "";

      // Always show overall spotlight at top (makes ‚Äúoverall‚Äù stand out everywhere)
      contentEl.appendChild(makeSpotlightBar());

      const grid = document.createElement("div");
      grid.className = "grid3";

      for (const category of CATEGORIES){
        const catMeta = CAT_META[category];

        const panel = document.createElement("div");
        panel.className = `panel ${catMeta.className} ${category === "ACE" ? "acePanel" : ""}`;

        const header = document.createElement("div");
        header.className = "panelHeader";

        if (category === "ACE") {
          header.innerHTML = `
            <div class="aceHeaderLeft">
              <div class="aceMark">‚öîÔ∏è</div>
              <div>
                <div class="panelTitle">ACE SPOTLIGHT</div>
                <div class="aceSub">Advanced / academy division</div>
              </div>
            </div>
            <div class="pill">${catMeta.label}</div>
          `;
        } else {
          header.innerHTML = `
            <div class="panelTitle">CATEGORY</div>
            <div class="pill">${catMeta.label}</div>
          `;
        }

        const body = document.createElement("div");
        body.className = "panelBody mini";

        const entries = sortEntries(
          [...players.entries()].filter(([_, p]) => p.division === division && p.category === category)
        );

        body.appendChild(makeTable(entries, true));

        panel.appendChild(header);
        panel.appendChild(body);
        grid.appendChild(panel);
      }

      contentEl.appendChild(grid);
    }

    function render(){
      contentEl.classList.remove("fadeSwap");
      void contentEl.offsetWidth;
      contentEl.classList.add("fadeSwap");

      const v = currentView();
      if (v.type === "overall") renderOverall();
      if (v.type === "division") renderDivision(v.division);

      updatedText.textContent = `Last updated: ${new Date().toLocaleString()}`;
      leaderHypeCheck();
    }

    function goToView(idx){
      viewIndex = ((idx % VIEWS.length) + VIEWS.length) % VIEWS.length;
      lastRotateAt = performance.now();
      render();
    }
    function nextView(){ goToView(viewIndex + 1); }
    function prevView(){ goToView(viewIndex - 1); }

    function startRotation(){
      stopRotation();
      lastRotateAt = performance.now();
      rotateTimer = setInterval(() => {
        if (!isPaused) nextView();
      }, ROTATE_MS);
    }
    function stopRotation(){
      if (rotateTimer) clearInterval(rotateTimer);
      rotateTimer = null;
    }
    function togglePause(){
      isPaused = !isPaused;
      screenHintEl.textContent = isPaused ? "Paused (press Space to resume)" : "Auto-rotating";
      lastRotateAt = performance.now();
    }

    // Progress animation for next screen
    function tick(){
      const now = performance.now();
      const elapsed = now - lastRotateAt;
      const pct = isPaused ? 0 : Math.min(100, (elapsed / ROTATE_MS) * 100);
      progressInner.style.width = pct + "%";
      requestAnimationFrame(tick);
    }

    window.addEventListener("keydown", (e) => {
      if (e.code === "KeyN") { e.preventDefault(); nextView(); }
      if (e.code === "KeyP") { e.preventDefault(); prevView(); }
      if (e.code === "Space") { e.preventDefault(); togglePause(); }
    });

    // =============================
    // 5) BOOT
    // =============================
    loadState();
    render();
    startRotation();
    tick();
  </script>
</body>
</html>
